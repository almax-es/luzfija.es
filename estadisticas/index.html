<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://luzfija.goatcounter.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data: https://luzfija.goatcounter.com; connect-src 'self' https://luzfija.goatcounter.com; worker-src 'self' blob:; form-action 'self';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark light"/>
  <meta name="description" content="Observatorio interactivo del PVPC. Analiza la evoluci√≥n hist√≥rica, el mapa de calor de precios y el reloj del ahorro solar en Espa√±a.">
  
  <title>Observatorio PVPC - Estad√≠sticas de la Luz | LuzFija.es</title>
  
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/fonts.css">
  
  <script src="/js/config.js"></script>
  <script src="/js/theme.js"></script>
  <script src="/js/tracking.js" defer data-goatcounter="https://luzfija.goatcounter.com/count"></script>

  <style>
    :root {
        --color-level-0: #10b981; /* Verde */
        --color-level-1: #84cc16;
        --color-level-2: #f59e0b;
        --color-level-3: #f97316;
        --color-level-4: #ef4444; /* Rojo */
    }

    .stats-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .stats-header { text-align: center; margin-bottom: 2rem; }
    
    .stats-controls { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }

    select {
        appearance: none; padding: 0.6rem 2.5rem 0.6rem 1rem; border-radius: 10px;
        border: 2px solid var(--border-color); background-color: var(--bg-card);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238b5cf6' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: right 1rem center;
        color: var(--text-main); font-size: 1rem; font-weight: 600; cursor: pointer; min-width: 180px;
    }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .kpi-card { background: var(--bg-card); padding: 1.2rem; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; }
    .kpi-val { font-size: 2rem; font-weight: 800; color: var(--primary-color); margin: 0.2rem 0; }
    .kpi-lab { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }

    .insight-box {
        background: var(--primary-color); color: white; padding: 1rem; border-radius: 12px;
        margin-bottom: 2rem; font-weight: 500; display: flex; align-items: center; gap: 1rem;
    }

    .chart-card { background: var(--bg-card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 2rem; }
    .chart-card h2 { margin-top: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }

    /* HEATMAP STYLE */
    .heatmap-container { overflow-x: auto; padding-bottom: 1rem; }
    .heatmap-grid {
        display: grid;
        grid-template-flow: column;
        grid-template-columns: repeat(53, 14px);
        grid-template-rows: repeat(7, 14px);
        gap: 3px;
        width: max-content;
    }
    .heatmap-day { width: 14px; height: 14px; border-radius: 2px; background: var(--border-color); position: relative; cursor: pointer; }
    .heatmap-day:hover { transform: scale(1.3); z-index: 10; outline: 1px solid white; }
    .heatmap-legend { display: flex; gap: 4px; align-items: center; margin-top: 10px; font-size: 10px; color: var(--text-muted); }
    .legend-box { width: 10px; height: 10px; border-radius: 2px; }

    /* TOOLTIP FOR HEATMAP */
    .heatmap-day::after {
        content: attr(data-tip);
        position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
        background: #333; color: white; padding: 4px 8px; border-radius: 4px;
        font-size: 10px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    .heatmap-day:hover::after { opacity: 1; }

    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: 1fr 1fr; }
        .chart-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>

  <nav style="background: var(--bg-card); padding: 1rem; border-bottom: 1px solid var(--border-color);">
    <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <a href="/" style="text-decoration: none; font-weight: 800; color: var(--primary-color); letter-spacing: -0.5px;">‚ö° LUZFIJA<span style="color:var(--text-main)">.ES</span></a>
      <a href="/" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">‚Üê Volver al comparador</a>
    </div>
  </nav>

  <div id="loading" class="loading-overlay hidden"><div class="spinner"></div></div>

  <div class="stats-container">
    <header class="stats-header">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Observatorio PVPC</h1>
        <p style="color: var(--text-muted);">An√°lisis avanzado de la tarifa regulada y el mercado el√©ctrico.</p>
    </header>

    <div class="stats-controls">
        <select id="geoSelector">
            <option value="8741">Pen√≠nsula</option>
            <option value="8742">Canarias</option>
            <option value="8743">Baleares</option>
            <option value="8744">Ceuta</option>
            <option value="8745">Melilla</option>
        </select>
        <select id="yearSelector">
            <option value="2026">2026 (En curso)</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021 (Desde Junio)</option>
        </select>
    </div>

    <div id="insight" class="insight-box hidden">
        <span style="font-size: 1.5rem;">üí°</span>
        <span id="insightText">Analizando tendencias...</span>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-lab">Media Anual</div><div class="kpi-val" id="kpiAvg">--</div><div class="kpi-sub">‚Ç¨/kWh</div></div>
        <div class="kpi-card"><div class="kpi-lab">D√≠a m√°s barato</div><div class="kpi-val" style="color:var(--color-level-0)" id="kpiMin">--</div><div class="kpi-sub" id="kpiMinDate">--</div></div>
        <div class="kpi-card"><div class="kpi-lab">D√≠a m√°s caro</div><div class="kpi-val" style="color:var(--color-level-4)" id="kpiMax">--</div><div class="kpi-sub" id="kpiMaxDate">--</div></div>
        <div class="kpi-card"><div class="kpi-lab">Horas de Sol</div><div class="kpi-val" style="color:#fbbf24" id="kpiSolar">--</div><div class="kpi-sub">Media 12h-17h</div></div>
    </div>

    <!-- HEATMAP -->
    <div class="chart-card">
        <h2>üóìÔ∏è Mapa de Calor de Precios</h2>
        <p style="color:var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem;">Cada cuadro es un d√≠a del a√±o. De verde (barato) a rojo (caro).</p>
        <div class="heatmap-container">
            <div id="heatmapGrid" class="heatmap-grid"></div>
        </div>
        <div class="heatmap-legend">
            <span>Barato</span>
            <div class="legend-box" style="background:var(--color-level-0)"></div>
            <div class="legend-box" style="background:var(--color-level-1)"></div>
            <div class="legend-box" style="background:var(--color-level-2)"></div>
            <div class="legend-box" style="background:var(--color-level-3)"></div>
            <div class="legend-box" style="background:var(--color-level-4)"></div>
            <span>Caro</span>
        </div>
    </div>

    <div class="chart-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <!-- CLOCK CHART -->
        <div class="chart-card">
            <h2>üïí Reloj del Ahorro</h2>
            <p style="color:var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Promedio horario. El "valle solar" es visible al mediod√≠a.</p>
            <div style="max-width: 400px; margin: 0 auto;">
                <canvas id="clockChart"></canvas>
            </div>
        </div>

        <!-- WEEKDAY CHART -->
        <div class="chart-card">
            <h2>üìÖ Promedio por D√≠a</h2>
            <p style="color:var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Los fines de semana suelen ser periodo valle.</p>
            <canvas id="weekdayChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h2>üìâ Evoluci√≥n Diaria</h2>
        <canvas id="dailyChart" height="80"></canvas>
    </div>

    <div class="chart-card">
        <h2>üÜö Comparativa Multianual</h2>
        <canvas id="comparisonChart" height="80"></canvas>
    </div>

    <div style="background: var(--bg-card); border: 2px solid var(--primary-color); border-radius: 20px; padding: 2.5rem; text-align: center; margin: 4rem 0;">
        <h2 style="font-size: 1.8rem; margin-bottom: 1rem;">¬øTu tarifa actual es mejor que el PVPC?</h2>
        <p style="color: var(--text-muted); margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
            No adivines. El PVPC es vol√°til. Usa tus datos reales para comparar el precio regulado con las mejores ofertas fijas del mercado.
        </p>
        <a href="/" class="btn" style="background: var(--primary-color); color: white; padding: 1rem 2.5rem; font-size: 1.1rem; border: none; font-weight: 700;">Ir al Comparador Principal</a>
    </div>

    <section style="margin-top: 4rem; max-width: 800px; margin-left: auto; margin-right: auto;">
        <h2 style="text-align: center; margin-bottom: 2rem;">Preguntas Frecuentes</h2>
        <div style="display: grid; gap: 2rem;">
            <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">¬øA qu√© hora es m√°s barata la luz en 2025?</h3>
                <p style="color: var(--text-muted); line-height: 1.6;">Gracias al r√©cord de energ√≠a solar, las horas m√°s baratas suelen ser entre las 11:00 y las 17:00. El antiguo "horario nocturno" ha dejado de ser el m√°s econ√≥mico en muchos d√≠as del a√±o.</p>
            </div>
            <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">¬øPor qu√© hay precios a 0‚Ç¨ o negativos?</h3>
                <p style="color: var(--text-muted); line-height: 1.6;">Ocurre cuando hay un exceso de producci√≥n (mucho viento y sol) y poca demanda. Sin embargo, t√∫ sigues pagando peajes y cargos, por lo que el precio final nunca es realmente cero, aunque s√≠ muy bajo.</p>
            </div>
        </div>
    </section>

  </div>

  <footer style="text-align: center; padding: 4rem 2rem; color: var(--text-muted); border-top: 1px solid var(--border-color); margin-top: 4rem; font-size: 0.9rem;">
    <p>Datos oficiales REE/ESIOS (Indicador 1001). Los precios mostrados incluyen peajes y cargos pero no el IVA/IGIC/IPSI.</p>
    <p>&copy; 2026 LuzFija.es ‚Äî Herramienta independiente y gratuita.</p>
  </footer>

  <script src="/vendor/chartjs/chart.umd.js" defer></script>
  <script src="/js/pvpc-stats-engine.js" defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const geoSel = document.getElementById('geoSelector');
        const yearSel = document.getElementById('yearSelector');
        const loader = document.getElementById('loading');
        const heatmap = document.getElementById('heatmapGrid');
        
        let charts = {};

        async function updateStats() {
            loader.classList.remove('hidden');
            const geoId = geoSel.value;
            const year = yearSel.value;
            document.title = `Evoluci√≥n PVPC ${year} - Observatorio LuzFija.es`;

            try {
                const data = await window.PVPC_STATS.loadYearData(geoId, year);
                if (!data || !Object.keys(data.days).length) return;

                const kpis = window.PVPC_STATS.getKPIs(data);
                document.getElementById('kpiAvg').textContent = kpis.avgPrice.toFixed(4);
                document.getElementById('kpiMin').textContent = kpis.minPrice.toFixed(4);
                document.getElementById('kpiMinDate').textContent = new Date(kpis.minHour.date).toLocaleDateString();
                document.getElementById('kpiMax').textContent = kpis.maxPrice.toFixed(4);
                document.getElementById('kpiMaxDate').textContent = new Date(kpis.maxHour.date).toLocaleDateString();

                // Calcular Media Solar (12h a 17h)
                const hourly = window.PVPC_STATS.getHourlyProfile(data).data;
                const solarAvg = (hourly[12]+hourly[13]+hourly[14]+hourly[15]+hourly[16]+hourly[17]) / 6;
                document.getElementById('kpiSolar').textContent = solarAvg.toFixed(4);

                renderHeatmap(data);
                renderClockChart(hourly);
                renderWeekdayChart(window.PVPC_STATS.getWeekdayProfile(data));
                renderDailyChart(window.PVPC_STATS.getDailyEvolution(data));
                renderComparisonChart(geoId, ['2022', '2023', '2024', '2025', '2026']);
                updateInsight(year, kpis.avgPrice, geoId);

            } catch (e) { console.error(e); }
            finally { loader.classList.add('hidden'); }
        }

        function renderHeatmap(yearData) {
            const data = window.PVPC_STATS.getHeatmapData(yearData);
            heatmap.innerHTML = '';
            
            // Crear 53 columnas (semanas)
            data.forEach(day => {
                const div = document.createElement('div');
                div.className = 'heatmap-day';
                div.style.background = `var(--color-level-${day.intensity})`;
                div.setAttribute('data-tip', `${new Date(day.date).toLocaleDateString()}: ${day.price.toFixed(4)}‚Ç¨`);
                heatmap.appendChild(div);
            });
        }

        function renderClockChart(data) {
            const ctx = document.getElementById('clockChart').getContext('2d');
            if (charts.clock) charts.clock.destroy();
            charts.clock = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: Array.from({length:24}, (_,i)=>`${i}h`),
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(v => {
                            const ratio = (v - Math.min(...data)) / (Math.max(...data) - Math.min(...data));
                            return `hsla(${(1-ratio)*120}, 70%, 50%, 0.6)`;
                        })
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { r: { ticks: { display: false } } }
                }
            });
        }

        function renderWeekdayChart(processed) {
            const ctx = document.getElementById('weekdayChart').getContext('2d');
            if (charts.weekday) charts.weekday.destroy();
            charts.weekday = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: processed.labels,
                    datasets: [{
                        data: processed.data,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 6
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function renderDailyChart(processed) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            if (charts.daily) charts.daily.destroy();
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: processed.labels,
                    datasets: [{
                        label: 'Precio (‚Ç¨/kWh)',
                        data: processed.data,
                        borderColor: '#3b82f6',
                        fill: true,
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: { 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } } 
                }
            });
        }

        async function renderComparisonChart(geoId, years) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const comparisonData = await window.PVPC_STATS.getMultiYearComparison(geoId, years);
            if (charts.comparison) charts.comparison.destroy();
            const colors = {'2022':'#ef4444','2023':'#f59e0b','2024':'#10b981','2025':'#3b82f6','2026':'#8b5cf6'};
            charts.comparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: comparisonData.labels,
                    datasets: comparisonData.datasets.map(ds => ({
                        ...ds, borderColor: colors[ds.label] || '#999', borderWidth: ds.label === yearSel.value ? 4 : 1, pointRadius: 0
                    }))
                },
                options: { interaction: { mode: 'index', intersect: false } }
            });
        }

        async function updateInsight(year, currentAvg, geoId) {
            const box = document.getElementById('insight');
            const text = document.getElementById('insightText');
            box.classList.remove('hidden');

            const prevYear = parseInt(year) - 1;
            if (prevYear >= 2022) {
                const prevData = await window.PVPC_STATS.loadYearData(geoId, prevYear);
                const prevAvg = window.PVPC_STATS.getKPIs(prevData).avgPrice;
                const diff = ((currentAvg - prevAvg) / prevAvg) * 100;
                const trend = diff > 0 ? 'm√°s caro' : 'm√°s barato';
                text.textContent = `En ${year}, el PVPC est√° siendo un ${Math.abs(diff).toFixed(1)}% ${trend} que en ${prevYear}.`;
            } else {
                text.textContent = `Analizando el mercado de ${year}. Utiliza el Reloj del Ahorro para planificar tus consumos solares.`;
            }
        }

        geoSel.addEventListener('change', updateStats);
        yearSel.addEventListener('change', updateStats);
        updateStats();
    });
  </script>
</body>
</html>
