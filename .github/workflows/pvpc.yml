name: PVPC Daily Update

on:
  # Ejecución diaria a las 21:00 Madrid (20:00 UTC)
  # ESIOS publica precios de mañana ~20:15, así que 21:00 es seguro
  schedule:
    - cron: '0 20 * * *'

  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-pvpc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download PVPC data (auto-detect gaps)
        env:
          ESIOS_API_KEY: ${{ secrets.ESIOS_API_KEY }}
        run: |
          # El script detecta automáticamente:
          # - Días faltantes en mes actual + anterior
          # - Descarga huecos + hoy + mañana
          python scripts/pvpc_auto_fill.py \
            --out-dir data/pvpc \
            --geos 8741 8742 8743 8744 8745

      - name: Check if there are changes
        id: check_changes
        run: |
          if git diff --quiet data/pvpc/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No hay cambios (datos ya actualizados)"
          else
            CHANGED_FILES=$(git diff --name-only data/pvpc/ | wc -l)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Actualizados $CHANGED_FILES archivos"
          fi

      - name: Commit and push if there are changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/pvpc/
          HORA=$(TZ=Europe/Madrid date +%H:%M)
          git commit -m "chore: actualizar precios PVPC - $HORA"
          git pull --rebase
          git push

      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "Precios actualizados correctamente"
          else
            echo "Datos ya estaban actualizados"
          fi
